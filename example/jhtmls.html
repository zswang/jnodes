<!DOCTYPE html>
<html>
<head>
  <title></title>
  <meta charset="utf8">
  <style>
    .star {
      background: gray;
    }
    textarea {
      width: 600px;
      height: 800px;
    }
  </style>
</head>
<body>
    <div id="books_jhtmls">
      <script type="text/jhtmls">
      <div>
        <button cmd="remove">remove</button>
        <button cmd="sort">sort</button>
        function _sort() {
          books.$$asc = -(books.$$asc || 1);
          books.sort(function (a, b) {
            return a.title.localeCompare(b.title) * books.$$asc;
          });
        }
        <button :cmd="_sort">_sort</button>
      </div>
      <ul :bind="books">
      books.forEach(function (book) {
        <li :bind="book" class="book" :class="{ star: book.star }">
          #{book.title}
          if (book.star) {
          <button cmd="star">ðŸŒŸ</button>
          } else {
          <button cmd="star">ðŸŒ›</button>
          }
        </li>
      });
      </ul>
      </script>
    </div>
    <textarea></textarea>
</body>
<script src="../node_modules/jhtmls/jhtmls.js"></script>
<script src="../node_modules/h5tap/h5tap.js"></script>
<script src="../jnodes.js"></script>
<script src="books.js"></script>
<script>
function compiler_jhtmls(node, bindObjectName) {
    var indent = node.indent || '';
    var inserFlag = "/***/ ";
    if (node.type === 'root') {
        node.beforebegin = "" + indent + inserFlag + "var _rootScope_ = " + bindObjectName + ".bind(this, { root: true }, null, function (_output_, _scope_) {";
        node.afterend = "\n" + indent + inserFlag + "}); _rootScope_.innerRender(_output_); " + bindObjectName + ".bind.$$scope = _rootScope_;";
        return;
    }
    if (!node.tag) {
        return;
    }
    if (node.tag === ':template') {
        node.attrs.some(function (attr) {
            if (attr.name === 'name') {
                node.overwriteNode = "\n" + indent + inserFlag + "_output_.push(" + bindObjectName + ".templateRender(" + JSON.stringify(attr.value) + ", _scope_, " + bindObjectName + ".bind));";
                return true;
            }
        });
        return;
    }
    if (!node.attrs || !node.attrs.length) {
        return;
    }
    var varintAttrs = "" + indent + inserFlag + "var _attrs_ = [\n";
    var hasOverwriteAttr;
    var bindDataValue;
    node.attrs.forEach(function (attr) {
        var value;
        if (attr.name[0] === ':') {
            if (attr.name === ':bind') {
                bindDataValue = attr.value;
            }
            hasOverwriteAttr = true;
            value = attr.value;
        }
        else {
            value = JSON.stringify(attr.value);
        }
        varintAttrs += "" + indent + inserFlag + "{ name: " + JSON.stringify(attr.name) + ", value: " + value + ", quoted: " + JSON.stringify(attr.quoted) + "},\n";
    });
    if (!hasOverwriteAttr) {
        return;
    }
    node.beforebegin = '';
    if (bindDataValue) {
        node.beforebegin += "\n" + indent + inserFlag + bindObjectName + ".bind(" + bindDataValue + ", _scope_, function (_output_, _scope_, holdInner) {\n";
        node.beforeend = "\n" + indent + inserFlag + "_scope_.innerRender = function(_output_) {\n";
        node.afterbegin = "\n" + indent + inserFlag + "}; if (holdInner) { _scope_.innerRender(_output_); }\n";
        node.afterend = "\n" + indent + inserFlag + "}).outerRender(_output_, true);\n";
    }
    varintAttrs += "" + indent + inserFlag + "];\n";
    node.beforebegin += varintAttrs;
    node.overwriteAttrs = '!#{_scope_.attrsRender(_scope_, _attrs_)}';
} /*</function>*/
</script>
<script>
(function () {
  var rootData = {
    books: books.slice(0, 10).map(function(book) {
      book.star = false;
      return book;
    })
  }

  var binder = new jnodes.Binder();

  jnodes.bind = function () {
    return binder.bind.apply(binder, arguments);
  };

  var element = document.querySelector('#books_jhtmls');
  var script = document.querySelector('#books_jhtmls script');

  // var compiler = new jnodes.Compiler();
  var root = jnodes.Parser.parse(script.innerHTML);
  var textarea = document.querySelector('textarea')
  var template = jnodes.Parser.build(root, 'jnodes', compiler_jhtmls);
  textarea.value = template;
  element.innerHTML = jhtmls.render(template, rootData);

  jnodes.bind.$$scope.element = element;

  h5tap(element, 'button', function (element) {
    var scope = binder.scope(element);
    if (!scope) {
      return;
    }
    var cmd = element.getAttribute('cmd');
    switch (cmd) {
      case 'star':
        scope.model.star = !scope.model.star;

        break;
      case 'remove':
        scope.model.books.shift();
        break;
      case 'sort':
        scope.model.books.$$asc = -(scope.model.books.$$asc || 1);
        scope.model.books.sort(function (a, b) {
          return a.title.localeCompare(b.title) * (scope.model.books.$$asc);
        })
        break;
      default:
        if (cmd[0] === '@') {
          var method = (scope.methods || {})[cmd]
          if (method) {
            method()
          }
        }
        break;
    }
  });
})();
</script>
</html>
